<script type="text/javascript">
  var RuntimeerrorNotifier = {
    notify: function(error) {
      var errData = {
        message: error.message,
        lineNumber: error.lineNumber,
        fileName: error.fileName,
        stack: (error.stack || '').split("\n")
      }
      var data = escape(JSON.stringify(errData));
      var host = '<%= ENV['RUNTIMEERROR_NOTIFICATION_URL'] %>';
      var apiKey = escape('<%= ENV['RUNTIMEERROR_EMAIL'] %>');
      var url = host + '?api_key=' + apiKey + '&data=' + data;

      requestFrame = document.createElement('iframe');
      requestFrame.style.width = '1px';
      requestFrame.style.height = '1px';
      requestFrame.style.display = 'none';
      requestFrame.src = url;
      requestFrame.onload = function() { this.parentNode.removeChild(this); }
      document.getElementsByTagName('head')[0].appendChild(requestFrame);
    }
  }

  window.onerror = function(message, fileName, lineNumber) {
    setTimeout(function() {
      // uncaught exceptions has no context of the stack
      RuntimeerrorNotifier.notify({
        message : message,
        fileName: fileName,
        lineNumber: lineNumber
      });
    }, 100);
    return true;
  };
</script>
